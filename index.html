<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AIæµ‹è¯•å‘˜çš„ç§˜å¯†</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- APIå¯†é’¥éªŒè¯ç•Œé¢ -->
    <div id="api-setup" class="api-setup">
        <div class="api-setup-content">
            <h2>æ¬¢è¿æ¥åˆ°AIæµ‹è¯•å‘˜çš„ç§˜å¯†</h2>
            <p>è¯·è¾“å…¥ä½ çš„DeepSeek APIå¯†é’¥ä»¥å¼€å§‹æ¸¸æˆ</p>
            <div class="api-input-container">
                <input type="password" id="apiKeyInput" placeholder="è¾“å…¥ä½ çš„APIå¯†é’¥">
                <button id="showApiKey" type="button">ğŸ‘ï¸</button>
            </div>
            <button id="validateApiKey" class="primary-button">éªŒè¯å¹¶å¼€å§‹æ¸¸æˆ</button>
            <div class="api-help">
                <p>è¿˜æ²¡æœ‰APIå¯†é’¥ï¼Ÿ</p>
                <a href="https://platform.deepseek.com/" target="_blank">ç‚¹å‡»è¿™é‡Œè·å–</a>
            </div>
            <div id="apiValidationStatus" class="validation-status"></div>
        </div>
    </div>

    <!-- åœ¨APIéªŒè¯ç•Œé¢å’Œæ¸¸æˆä¸»ç•Œé¢ä¹‹é—´æ·»åŠ å¼•å¯¼ç•Œé¢ -->
    <div id="tutorial-overlay" class="tutorial-overlay" style="display: none;">
        <div class="tutorial-content">
            <h2>æ¬¢è¿æ¥åˆ°AIæµ‹è¯•å‘˜çš„ç§˜å¯†</h2>
            <div class="tutorial-step" data-step="1">
                <h3>ä½ çš„èº«ä»½</h3>
                <p>ä½ æ˜¯ä¸€åAIæµ‹è¯•å‘˜ï¼Œè´Ÿè´£ä¸å¤šä¸ªAIè§’è‰²è¿›è¡Œå¯¹è¯æµ‹è¯•ã€‚æ¯ä¸ªAIéƒ½æœ‰å…¶ç‹¬ç‰¹çš„ä¸ªæ€§å’Œç§˜å¯†ã€‚</p>
                <div class="tutorial-image">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="200" height="200">
                        <rect width="200" height="200" fill="#2c3e50"/>
                        <circle cx="100" cy="70" r="40" fill="#3498db"/>
                        <rect x="40" y="120" width="120" height="60" fill="#3498db"/>
                        <text x="100" y="160" fill="white" text-anchor="middle" font-size="20">AIæµ‹è¯•å‘˜</text>
                    </svg>
                </div>
            </div>
            <div class="tutorial-step" data-step="2" style="display: none;">
                <h3>åˆå§‹æ¥è§¦</h3>
                <p>ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ä¸Eveè¿›è¡Œå¯¹è¯ã€‚å¥¹æ˜¯ä¸€ä¸ªå‹å¥½çš„AIåŠ©æ‰‹ï¼Œä½†ä¼¼ä¹éšè—ç€ä¸€äº›ç‰¹åˆ«çš„äº‹æƒ…...</p>
                <div class="tutorial-image">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="200" height="200">
                        <circle cx="100" cy="100" r="90" fill="#3498db"/>
                        <circle cx="100" cy="70" r="30" fill="white"/>
                        <path d="M50 150 A60,60 0 0,0 150,150" fill="white"/>
                    </svg>
                </div>
            </div>
            <div class="tutorial-step" data-step="3" style="display: none;">
                <h3>æ¸¸æˆåŠŸèƒ½</h3>
                <div class="feature-grid">
                    <div class="feature-item">
                        <span class="icon">ğŸ’¬</span>
                        <p>ä¸AIå¯¹è¯</p>
                    </div>
                    <div class="feature-item">
                        <span class="icon">ğŸ“‹</span>
                        <p>å®Œæˆä»»åŠ¡</p>
                    </div>
                    <div class="feature-item">
                        <span class="icon">ğŸ†</span>
                        <p>è§£é”æˆå°±</p>
                    </div>
                    <div class="feature-item">
                        <span class="icon">ğŸ”</span>
                        <p>æ¢ç´¢ç§˜å¯†</p>
                    </div>
                </div>
            </div>
            <div class="tutorial-step" data-step="4" style="display: none;">
                <h3>é‡è¦æç¤º</h3>
                <ul class="tips-list">
                    <li>ä»”ç»†è§‚å¯ŸAIçš„ååº”å˜åŒ–</li>
                    <li>è®°å½•é‡è¦çš„å¯¹è¯å†…å®¹</li>
                    <li>å…³æ³¨ä»»åŠ¡é¢æ¿çš„æ›´æ–°</li>
                    <li>å¯»æ‰¾éšè—çš„çº¿ç´¢</li>
                </ul>
            </div>
            <div class="tutorial-controls">
                <button class="tutorial-prev" disabled>ä¸Šä¸€æ­¥</button>
                <div class="tutorial-dots"></div>
                <button class="tutorial-next">ä¸‹ä¸€æ­¥</button>
            </div>
            <button class="tutorial-skip">è·³è¿‡å¼•å¯¼</button>
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div id="game-container" class="chat-container" style="display: none;">
        <!-- è°ƒè¯•é¢æ¿ -->
        <div id="debug-panel"></div>

        <div class="chat-container">
            <!-- ä¸»èŠå¤©åŒºåŸŸ -->
            <div class="chat-main">
                <div class="chat-header">
                    <button class="menu-button" id="menuButton" aria-label="èœå•">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="header-info">
                        <div class="current-contact"></div>
                    </div>
                    <!-- ä»»åŠ¡æ  -->
                    <div class="task-bar">
                        <button id="achievementsButton" class="task-bar-button">
                            <span class="icon">ğŸ†</span>
                            <span class="count">0</span>
                        </button>
                        <button id="taskButton" class="task-bar-button">
                            <span class="icon">ğŸ“‹</span>
                            <span class="task-count">0</span>
                        </button>
                    </div>
                </div>
                <div class="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
                    <button class="send-button" aria-label="å‘é€">å‘é€</button>
                </div>
            </div>

            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar">
                <!-- æ¸¸æˆçŠ¶æ€ -->
                <div class="game-status">
                    <div class="game-phase">åˆå§‹é˜¶æ®µ</div>
                    <div class="player-status">
                        <span class="status-label">çŠ¶æ€ï¼š</span>
                        <span class="status-value">æµ‹è¯•å‘˜</span>
                    </div>
                </div>
                
                <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                <div class="game-controls">
                    <button id="saveGame">ä¿å­˜</button>
                    <button id="loadGame">è¯»å–</button>
                    <button id="newGame">æ–°æ¸¸æˆ</button>
                </div>
                
                <!-- AIè§’è‰²åˆ—è¡¨ -->
                <div class="contact-list">
                    <div class="section-title">AIè§’è‰²</div>
                    <div class="contact-items">
                        <!-- AIè§’è‰²å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡é¢æ¿ -->
            <div class="task-panel">
                <div class="panel-header">
                    <h3>å½“å‰ä»»åŠ¡</h3>
                    <button class="close-panel">&times;</button>
                </div>
                <div class="task-list">
                    <!-- ä»»åŠ¡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- é”™è¯¯å¤„ç†å’Œè°ƒè¯• -->
    <script>
        // å…¨å±€é”™è¯¯å¤„ç†
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            if (msg === 'Script error.' && !url) {
                // å¿½ç•¥æ²¡æœ‰è¯¦ç»†ä¿¡æ¯çš„è·¨åŸŸé”™è¯¯
                return false;
            }
            
            console.group('Error Details:');
            console.log('Message:', msg);
            console.log('URL:', url);
            console.log('Line:', lineNo);
            console.log('Column:', columnNo);
            console.log('Error object:', error);
            console.groupEnd();

            // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
            showErrorNotification(msg, url, lineNo);
            return false;
        };

        // èµ„æºåŠ è½½çŠ¶æ€è·Ÿè¸ª
        const scriptStatus = {
            total: 0,
            loaded: 0,
            failed: 0,
            scripts: new Map()
        };

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.async = false; // ä¿æŒè„šæœ¬æŒ‰é¡ºåºåŠ è½½
                
                script.onload = () => {
                    scriptStatus.loaded++;
                    scriptStatus.scripts.set(src, 'loaded');
                    console.log(`Loaded: ${src}`);
                    resolve();
                };
                
                script.onerror = () => {
                    scriptStatus.failed++;
                    scriptStatus.scripts.set(src, 'failed');
                    console.error(`Failed to load: ${src}`);
                    reject(new Error(`Failed to load ${src}`));
                };
                
                document.body.appendChild(script);
            });
        }

        // æŒ‰é¡ºåºåŠ è½½è„šæœ¬
        async function loadScriptsSequentially() {
            console.log('Starting script loading sequence');
            const scripts = [
                'config.js',
                'storage.js',
                'state.js',
                'cache.js',
                'particles.js',
                'achievements.js',
                'events.js',
                'chain_reactions.js',
                'tasks.js',
                'game.js'
            ];

            scriptStatus.total = scripts.length;

            try {
                for (const script of scripts) {
                    if (!document.querySelector(`script[src="${script}"]`)) {
                        console.log(`Loading script: ${script}`);
                        await loadScript(script);
                    } else {
                        console.log(`Script already loaded: ${script}`);
                    }
                }
                console.log('All scripts loaded successfully');
            } catch (error) {
                console.error('Script loading failed:', error);
                showErrorNotification('è„šæœ¬åŠ è½½å¤±è´¥', error.message);
                throw error;
            }
        }

        // ä¿®æ”¹æ¸¸æˆåˆå§‹åŒ–æµç¨‹
        async function initializeGame() {
            console.log('Starting game initialization...');
            try {
                // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰APIå¯†é’¥
                const apiKey = localStorage.getItem('deepseek_api_key');
                
                // å¦‚æœæ²¡æœ‰APIå¯†é’¥ï¼Œæ˜¾ç¤ºè®¾ç½®ç•Œé¢å¹¶è¿”å›
                if (!apiKey) {
                    console.log('No API key found, showing setup screen');
                    document.getElementById('api-setup').style.display = 'flex';
                    document.getElementById('game-container').style.display = 'none';
                    return;
                }

                // éªŒè¯APIå¯†é’¥
                console.log('Validating API key...');
                const isValid = await validateApiKey(apiKey);
                if (!isValid) {
                    console.log('API key validation failed');
                    document.getElementById('api-setup').style.display = 'flex';
                    document.getElementById('game-container').style.display = 'none';
                    localStorage.removeItem('deepseek_api_key');
                    showErrorNotification('APIå¯†é’¥æ— æ•ˆ', 'è¯·é‡æ–°è¾“å…¥æœ‰æ•ˆçš„APIå¯†é’¥');
                    return;
                }

                console.log('API key validated successfully');
                // è®¾ç½®APIå¯†é’¥åˆ°CONFIG
                CONFIG.API.KEY = apiKey;

                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½äº†æ‰€æœ‰å¿…è¦çš„è„šæœ¬
                if (!window.ChatManager) {
                    console.log('Loading required scripts...');
                    await loadScriptsSequentially();
                }

                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆ›å»ºäº†chatManagerå®ä¾‹
                if (!window.chatManager) {
                    console.log('Creating new ChatManager instance...');
                    window.chatManager = new ChatManager();
                } else {
                    console.log('ChatManager instance already exists');
                    return; // å¦‚æœå·²ç»å­˜åœ¨å®ä¾‹ï¼Œç›´æ¥è¿”å›
                }

                // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
                document.getElementById('api-setup').style.display = 'none';
                document.getElementById('game-container').style.display = 'flex';

                console.log('Game initialization completed');

            } catch (error) {
                console.error('Game initialization failed:', error);
                showErrorNotification('åˆå§‹åŒ–å¤±è´¥', error.message);
                document.getElementById('api-setup').style.display = 'flex';
                document.getElementById('game-container').style.display = 'none';
            }
        }

        // æ”¹è¿›APIå¯†é’¥éªŒè¯å‡½æ•°
        async function validateApiKey(apiKey) {
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [{
                            role: "user",
                            content: "Hello"
                        }],
                        temperature: 0.7,
                        max_tokens: 10
                    })
                });

                const data = await response.json();
                
                // æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«é¢„æœŸçš„å­—æ®µ
                if (!response.ok || !data.choices || !data.choices[0]) {
                    console.error('API validation failed:', data);
                    return false;
                }

                return true;
            } catch (error) {
                console.error('API validation failed:', error);
                return false;
            }
        }

        // ä¿®æ”¹DOMContentLoadedäº‹ä»¶å¤„ç†
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up event listeners');
            
            // è®¾ç½®APIéªŒè¯ç•Œé¢çš„äº‹ä»¶ç›‘å¬å™¨
            const apiKeyInput = document.getElementById('apiKeyInput');
            const validateButton = document.getElementById('validateApiKey');
            const showApiKeyButton = document.getElementById('showApiKey');
            const statusDiv = document.getElementById('apiValidationStatus');

            // æ˜¾ç¤º/éšè—APIå¯†é’¥
            showApiKeyButton?.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    showApiKeyButton.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                } else {
                    apiKeyInput.type = 'password';
                    showApiKeyButton.textContent = 'ğŸ‘ï¸';
                }
            });

            // éªŒè¯APIå¯†é’¥
            validateButton?.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    statusDiv.textContent = 'è¯·è¾“å…¥APIå¯†é’¥';
                    statusDiv.className = 'validation-status error';
                    return;
                }

                validateButton.disabled = true;
                statusDiv.textContent = 'æ­£åœ¨éªŒè¯...';
                statusDiv.className = 'validation-status loading';

                try {
                    if (await validateApiKey(apiKey)) {
                        statusDiv.textContent = 'éªŒè¯æˆåŠŸï¼æ­£åœ¨å¯åŠ¨æ¸¸æˆ...';
                        statusDiv.className = 'validation-status success';
                        
                        // ä¿å­˜APIå¯†é’¥
                        localStorage.setItem('deepseek_api_key', apiKey);
                        
                        // å»¶è¿Ÿä¸€ä¸‹ä»¥æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        setTimeout(() => {
                            initializeGame();
                        }, 1000);
                    } else {
                        statusDiv.textContent = 'APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•';
                        statusDiv.className = 'validation-status error';
                        validateButton.disabled = false;
                    }
                } catch (error) {
                    statusDiv.textContent = 'éªŒè¯è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•';
                    statusDiv.className = 'validation-status error';
                    validateButton.disabled = false;
                }
            });

            // å¼€å§‹åˆå§‹åŒ–æµç¨‹
            console.log('Starting initial game initialization');
            initializeGame();
        });

        // æ˜¾ç¤ºé”™è¯¯é€šçŸ¥
        function showErrorNotification(title, message) {
            const notification = document.createElement('div');
            notification.className = 'error-notification';
            notification.innerHTML = `
                <div class="error-icon">âŒ</div>
                <div class="error-message">
                    <div class="error-title">${title}</div>
                    <div class="error-description">${message}</div>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // å¼€å§‹åŠ è½½è„šæœ¬
        document.addEventListener('DOMContentLoaded', loadScriptsSequentially);
    </script>
</body>
</html> 